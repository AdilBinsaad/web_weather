<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Weather — iOS style</title>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --glass: rgba(255,255,255,.14);
      --glass-soft: rgba(255,255,255,.12);
      --muted:#cfd6de;
      --text:#ffffff;
    }
    body[data-theme="dark"]{
      --text:#ffffff;
      --muted:#cfd6de;
      --glass: rgba(255,255,255,.14);
      --glass-soft: rgba(255,255,255,.12);
      --bg-radial:#48566a; --bg-top:#1f2834; --bg-mid:#2b3a4a; --bg-bottom:#2e3641;
      --glow: rgba(124,164,255,.22); --stars-opacity: .45;
    }
    body[data-theme="light"]{
      --text:#0b1220; --muted:#526170;
      --glass: rgba(255,255,255,.50); --glass-soft: rgba(255,255,255,.36);
      --bg-radial:#ffffff; --bg-top:#e8f1ff; --bg-mid:#d6e7ff; --bg-bottom:#c7dcff;
      --glow: rgba(255,255,255,.65); --stars-opacity: 0;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","Segoe UI",Roboto,Arial,sans-serif;
      color:var(--text); min-height:100vh;
      background:
        radial-gradient(1200px 600px at 70% -100px, var(--bg-radial) 0%, rgba(0,0,0,0) 70%),
        linear-gradient(180deg, var(--bg-top) 0%, var(--bg-mid) 60%, var(--bg-bottom) 100%);
      background-attachment: fixed, fixed; background-size:120% 120%, 100% 100%;
      animation: drift 40s ease-in-out infinite; position:relative; overflow-x:hidden;
    }
    body[data-theme="dark"]::before{
      content:""; position:fixed; inset:-25% -10% auto -10%; height:150vh; pointer-events:none;
      background:
        radial-gradient(700px 420px at 68% 0%, var(--glow) 0%, rgba(255,255,255,0) 70%),
        radial-gradient(520px 320px at 20% 30%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 70%);
      filter: blur(0.5px); mix-blend-mode: screen; animation: float1 24s ease-in-out infinite alternate; opacity:.9;
    }
    body[data-theme="dark"]::after{
      content:""; position:fixed; inset:-2% -2% -2% -2%; pointer-events:none;
      background-image:
        radial-gradient(1px 1px at 5% 12%,  rgba(255,255,255,.95) 0, transparent 2px),
        radial-gradient(1.2px 1.2px at 12% 32%, rgba(255,255,255,.85) 0, transparent 2.2px),
        radial-gradient(1px 1px at 18% 68%, rgba(255,255,255,.9) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 28% 22%, rgba(255,255,255,.8) 0, transparent 2.4px),
        radial-gradient(1.2px 1.2px at 34% 78%, rgba(255,255,255,.9) 0, transparent 2.2px),
        radial-gradient(1px 1px at 42% 18%, rgba(255,255,255,.8) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 52% 62%, rgba(255,255,255,.85) 0, transparent 2.4px),
        radial-gradient(1px 1px at 60% 30%, rgba(255,255,255,.9) 0, transparent 2px),
        radial-gradient(1.2px 1.2px at 66% 80%, rgba(255,255,255,.85) 0, transparent 2.2px),
        radial-gradient(1px 1px at 74% 40%, rgba(255,255,255,.95) 0, transparent 2px),
        radial-gradient(1.4px 1.4px at 82% 72%, rgba(255,255,255,.9) 0, transparent 2.4px),
        radial-gradient(1px 1px at 90% 20%, rgba(255,255,255,.85) 0, transparent 2px),
        radial-gradient(2px 2px at 8% 55%, rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 26% 12%, rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 38% 46%, rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 58% 14%, rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 72% 58%, rgba(255,255,255,.6) 0, transparent 3px),
        radial-gradient(2px 2px at 88% 36%, rgba(255,255,255,.6) 0, transparent 3px);
      opacity: var(--stars-opacity); animation: twinkle 2.8s ease-in-out infinite alternate, starDrift 60s linear infinite;
    }
    body[data-theme="light"]::before{
      content:""; position:fixed; inset:-10% -10% -5% -10%; pointer-events:none;
      background:
        radial-gradient(90px 45px at 10% 18%, rgba(255,255,255,.45) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(120px 60px at 16% 20%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(100px 50px at 22% 18%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(120px 60px at 50% 22%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(140px 70px at 58% 24%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(110px 55px at 66% 22%, rgba(255,255,255,.55) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(150px 80px at 78% 34%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(170px 90px at 88% 36%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%),
        radial-gradient(130px 70px at 70% 38%, rgba(255,255,255,.65) 60%, rgba(255,255,255,0) 61%);
      filter: blur(0.3px); animation: cloudsDrift 60s linear infinite; opacity:.9; z-index:0;
    }
    body[data-theme="light"]::after{ content:none; }

    .wrap{ max-width:960px; margin:0 auto; padding:18px; position:relative; z-index:1; }
    .top{ padding:18px 8px 8px; text-align:center }
    .city{ font-size:1.6rem; letter-spacing:.5px }
    .temp{ font-size:6rem; font-weight:200; margin:.2rem 0 }
    .desc{ color:var(--muted); font-size:1.05rem }
    .toolbar{ display:flex; gap:.6rem; justify-content:center; align-items:center; margin-top:8px }
    select,button{
      padding:.55rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.18);
      background:var(--glass-soft); color:var(--text); backdrop-filter: blur(6px);
    }
    button{ border:0; cursor:pointer }

    .card{ background:var(--glass); border:1px solid rgba(255,255,255,.18); border-radius:18px; padding:12px 14px; backdrop-filter: blur(8px); }
    .alert{ margin:12px auto 8px; max-width:780px }
    .alert-title{ display:flex; align-items:center; gap:.5rem; font-weight:600 }
    .alert small{ color:var(--muted) }

    .section-title{ margin:12px 0 6px 6px; font-weight:600; opacity:.95 }
    .scroll{ display:flex; gap:10px; overflow-x:auto; padding:6px }
    .hcard{ min-width:70px; text-align:center }
    .h-time{ color:var(--muted); font-size:.95rem }
    .h-emoji{ font-size:1.25rem; margin:.15rem 0 }
    .h-temp{ font-size:1.1rem }
    .h-pop{ color:var(--muted); font-size:.9rem }

    .daily{ display:flex; flex-direction:column; gap:8px; padding:6px }
    /* ชื่อวัน | Tmin | แถบ temp | Tmax | อีโมจิ | %ฝน */
.drow{
  display:grid;
  grid-template-columns: 64px 48px 2fr 48px 36px 48px;
  align-items:center;
  gap:6px; /* ลดช่องว่างลงนิดหน่อย */
}

.bar{
  position:relative;
  height:10px; /* ขยายความสูงให้ชัดขึ้น */
  background:rgba(255,255,255,.12);
  border-radius:999px;
  overflow:hidden;
}

    .emo{ text-align:center; font-size:1.1rem; }
    .pop{ display:flex; align-items:center; justify-content:flex-end; gap:6px; }
    .d-min{text-align:right;opacity:.95} .d-max{text-align:left;opacity:.95} .d-name{color:var(--text);opacity:.95}
    .bar{ position:relative; height:8px; background:rgba(255,255,255,.12); border-radius:999px; overflow:hidden; }
    .bar-fill{ position:absolute; height:100%; background:#f39c12; border-radius:999px; }

    .muted{ color:var(--muted) }
    .footer{ text-align:center; color:var(--muted); margin:16px 0 8px }

    @keyframes drift{0%{background-position:0% 0%,0% 0%}50%{background-position:100% 50%,0% 0%}100%{background-position:0% 0%,0% 0%}}
    @keyframes float1{0%{transform:translate(-4%,-2%) scale(1);opacity:.85}100%{transform:translate(8%,4%) scale(1.12);opacity:1}}
    @keyframes twinkle{0%,100%{opacity:calc(var(--stars-opacity)*.6)}50%{opacity:calc(var(--stars-opacity)*1)}}
    @keyframes starDrift{0%{transform:translate3d(-1%,0,0)}100%{transform:translate3d(1%,0,0)}}
    @keyframes cloudsDrift{0%{transform:translate3d(-4%,0,0)}100%{transform:translate3d(4%,0,0)}}

    body[data-theme="light"] .d-name{color:#000}
    body[data-theme="light"] .toolbar label{color:#000}
    body[data-theme="light"] .toolbar select{color:#000}
    body[data-theme="light"] .toolbar option{color:#000}
    body[data-theme="dark"]  .toolbar option{color:#fff;background:#2e3641}
    body[data-theme="dark"]  .toolbar select{color:#fff}

    /* Sensor Data Styles */
    .chart-btn {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: 1px solid rgba(255,255,255,.18);
      background: var(--glass-soft);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .chart-btn.active {
      background: rgba(255,255,255,.3);
      border-color: rgba(255,255,255,.4);
    }
    
    .chart-btn:hover {
      background: rgba(255,255,255,.25);
    }
    
    #statusDot.online {
      background: #4CAF50;
      box-shadow: 0 0 6px #4CAF50;
    }
    
    #statusDot.offline {
      background: #f44336;
    }
    
    #statusDot.loading {
      background: #ff9800;
      animation: pulse 1.5s ease-in-out infinite alternate;
    }
    
    @keyframes pulse {
      from { opacity: 1; }
      to { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div style="font-size:.95rem; color:var(--muted)" id="clock">--:--</div>
      <div class="city" id="city">—</div>
      <div class="temp"><span id="temp">--</span>°</div>
      <div class="desc"><span id="desc">โหลดข้อมูล...</span></div>
      

      <div class="toolbar">
        <label for="citySel" class="muted">City</label>
        <select id="citySel"></select>
        <button id="btnReload">โหลดข้อมูล</button>

        <label for="themeSel" class="muted">Theme</label>
        <select id="themeSel">
          <option value="auto">Auto</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
    </div>

    <div id="alertBox" class="card alert" style="display:none">
      <div class="alert-title">⚠️ <span id="alertTitle">คำเตือนเรื่องฝนตกหนัก</span></div>
      <small id="alertSub" class="muted">ประกาศ: โอกาสฝนตกสูงจากพยากรณ์รายวัน</small>
    </div>

    <div id="rainHint" class="card alert" style="display:none"></div>

    <!-- ESP32 Sensor Data Section -->
    <div>
      <div class="section-title">🌡️ ข้อมูลเซ็นเซอร์ ESP32 (DHT11)</div>
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="font-weight: 600;">เซ็นเซอร์แบบเรียลไทม์</div>
          <div id="sensorStatus" style="display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
            <span id="statusDot" style="width: 8px; height: 8px; border-radius: 50%; background: #888;"></span>
            <span id="statusText" style="color: var(--muted);">กำลังโหลด...</span>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <div style="text-align: center; padding: 12px; background: var(--glass-soft); border-radius: 12px;">
            <div style="font-size: 1.5rem;">🌡️</div>
            <div style="color: var(--muted); font-size: 0.9rem; margin: 4px 0;">อุณหภูมิ</div>
            <div id="sensorTemp" style="font-size: 1.8rem; font-weight: 300;">--°C</div>
            <div id="sensorTempTime" style="color: var(--muted); font-size: 0.8rem; margin-top: 4px;">--</div>
          </div>
          <div style="text-align: center; padding: 12px; background: var(--glass-soft); border-radius: 12px;">
            <div style="font-size: 1.5rem;">💧</div>
            <div style="color: var(--muted); font-size: 0.9rem; margin: 4px 0;">ความชื้น</div>
            <div id="sensorHumidity" style="font-size: 1.8rem; font-weight: 300;">--%</div>
            <div id="sensorHumidityTime" style="color: var(--muted); font-size: 0.8rem; margin-top: 4px;">--</div>
          </div>
        </div>

        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <span style="font-weight: 600; font-size: 0.95rem;">📊 กราหข้อมูลย้อนหลัง</span>
            <div style="display: flex; gap: 4px;">
              <button class="chart-btn active" data-hours="6" style="padding: 4px 8px; font-size: 0.8rem;">6 ชม.</button>
              <button class="chart-btn" data-hours="12" style="padding: 4px 8px; font-size: 0.8rem;">12 ชม.</button>
              <button class="chart-btn" data-hours="24" style="padding: 4px 8px; font-size: 0.8rem;">24 ชม.</button>
            </div>
          </div>
          <div style="position: relative; height: 200px; background: var(--glass-soft); border-radius: 8px; padding: 8px;">
            <canvas id="sensorChart" style="width: 100%; height: 100%;"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div>
      <div class="section-title">พยากรณ์อากาศรายชั่วโมง</div>
      <div class="card scroll" id="hourly"></div>
    </div>

    <div>
      <div class="section-title">พยากรณ์อากาศ 7 วัน</div>
      <div class="card daily" id="daily"></div>
    </div>

    <div class="footer">แหล่งข้อมูล: OpenWeather • Dev by Sunisa & Adil</div>
  </div>

<script>
  /* ===== config & helpers ===== */
  const API_KEY = '50530efb777a0cf4a592a80c2b4c3b41';

  const CITY_COORDS = {
    bangkok:      { nameTH: "กรุงเทพฯ",  latitude: 13.7563, longitude: 100.5018 },
    "chiang mai": { nameTH: "เชียงใหม่", latitude: 18.7883, longitude: 98.9853 },
    phuket:       { nameTH: "ภูเก็ต",    latitude: 7.8804,  longitude: 98.3923 },
    "khon kaen":  { nameTH: "ขอนแก่น",  latitude: 16.4419, longitude: 102.8350 }
  };

  function pad2(n){ return String(n).padStart(2,"0"); }
  function updateClock(){ const d=new Date(); document.getElementById("clock").textContent=`${pad2(d.getHours())}:${pad2(d.getMinutes())}`; }
  setInterval(updateClock,1000); updateClock();

  let themeTimer=null;
  function pickThemeByTime(){ const h=new Date().getHours(); return (h>=6&&h<18)?"light":"dark"; }
  function applyThemeMode(mode){
    const m=mode||"auto"; localStorage.setItem("themeMode",m);
    if(themeTimer){clearInterval(themeTimer); themeTimer=null;}
    if(m==="light"||m==="dark"){ document.body.setAttribute("data-theme",m); }
    else{ const tick=()=>document.body.setAttribute("data-theme",pickThemeByTime()); tick(); themeTimer=setInterval(tick,60*1000); }
  }

  function owIdToEmoji(id){
    if(id>=200&&id<300) return '⛈️';
    if(id>=300&&id<600) return '🌧️';
    if(id>=600&&id<700) return '❄️';
    if(id>=700&&id<800) return '🌫️';
    if(id===800) return '☀️';
    if(id>800&&id<900) return '☁️';
    return '🌡️';
  }
  function wmoDescTHFromOW(id){
    const c=Number(id);
    if(c===800) return "ท้องฟ้าแจ่มใส";
    if(c>800&&c<900) return "มีเมฆมาก";
    if(c>=200&&c<300) return "พายุฝนฟ้าคะนอง";
    if(c>=300&&c<600) return "ฝนตก";
    if(c>=600&&c<700) return "หิมะ";
    if(c>=700&&c<800) return "มีหมอก";
    return "สภาพอากาศ";
  }
  function hourLabel(dt){ const h=dt.getHours(); return h===0?"24":String(h); }
  function popEmoji(p){ const v=Number(p)||0; if(v>=80)return"⛈️"; if(v>=60)return"🌧️"; if(v>=40)return"🌦️"; if(v>=20)return"🌤️"; return"☀️"; }
  function getCityInfo(key){ const k=(key||"bangkok").toLowerCase().trim(); return CITY_COORDS[k]?{key:k,...CITY_COORDS[k]}:{key:"bangkok",...CITY_COORDS["bangkok"]}; }
  async function loadCities(){ const sel=document.getElementById("citySel"); sel.innerHTML=""; Object.entries(CITY_COORDS).forEach(([key,v])=>{ const opt=document.createElement("option"); opt.value=key; opt.textContent=v.nameTH; sel.appendChild(opt);}); sel.value="bangkok"; }

  /* ===== openweather fetch (เหมือนเดิม) ===== */
  async function fetchWeather(cityKey){
    const cityInfo=getCityInfo(cityKey);
    const {latitude:lat, longitude:lon}=cityInfo;

    const forecastUrl=`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=th`;
    const currentUrl =`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric&lang=th`;
    const uvUrl      =`https://api.openweathermap.org/data/2.5/uvi?lat=${lat}&lon=${lon}&appid=${API_KEY}`;

    const [fRes,cRes,uRes]=await Promise.all([fetch(forecastUrl),fetch(currentUrl),fetch(uvUrl)]);
    if(!fRes.ok||!cRes.ok) throw new Error(`OpenWeather error ${fRes.status}/${cRes.status}`);

    const forecast=await fRes.json();
    const current =await cRes.json();
    let uv={value:"--"}; if(uRes.ok) uv=await uRes.json();

    return {cityInfo,current,forecast,uv};
  }

  /* ===== สรุปรายวัน (จาก 3 ชม.) ===== */
  function groupDailyFromForecast(list){
    const dailyMap={};
    list.forEach(item=>{
      const date=new Date(item.dt*1000);
      const key=date.toLocaleDateString('th-TH');
      const temp=item.main?.temp;
      const pop=(item.pop??0)*100;
      const wid=item.weather?.[0]?.id??800;
      if(!dailyMap[key]) dailyMap[key]={temps:[],pops:[],ids:[],dateObj:date};
      dailyMap[key].temps.push(temp);
      dailyMap[key].pops.push(pop);
      dailyMap[key].ids.push(wid);
    });
    const keys=Object.keys(dailyMap).sort((a,b)=>dailyMap[a].dateObj-dailyMap[b].dateObj);
    return keys.map(k=>{
      const d=dailyMap[k];
      const tmin  = Math.min(...d.temps);
      const tmax  = Math.max(...d.temps);
      const popAvg = d.pops.reduce((a,b)=>a+b,0) / d.pops.length;  // 0..100
      const iconId = d.ids[Math.floor(d.ids.length/2)] ?? d.ids[0] ?? 800; // เลือกไอคอนกลางวัน
      return { key:k, dateObj:d.dateObj, tmin, tmax, popAvg, iconId };
    });
  }

  /* ===== แปลง 3-ชั่วโมง ให้เป็นทุก 1 ชั่วโมง 24 ชั่วโมง (interpolate) ===== */
  function expandToHourly24(current, list){
    const now=new Date();
    const nowMs=now.getTime();

    const pts=list.map(it=>({
      t: it.dt*1000,
      temp: it.main?.temp ?? null,
      pop: (it.pop ?? 0)*100,
      wid: it.weather?.[0]?.id ?? 800
    }));
    pts.unshift({
      t: nowMs,
      temp: current?.main?.temp ?? (pts[0]?.temp ?? null),
      pop: (list?.[0]?.pop ?? 0)*100,
      wid: current?.weather?.[0]?.id ?? (pts[0]?.wid ?? 800)
    });
    pts.sort((a,b)=>a.t-b.t);

    function lerp(a,b,t){ return a+(b-a)*t; }
    function sampleAt(timeMs){
      let i=0; while(i<pts.length-1 && !(timeMs>=pts[i].t && timeMs<=pts[i+1].t)) i++;
      if(i>=pts.length-1){
        const last=pts[pts.length-1];
        return {temp:last.temp, pop:last.pop, wid:last.wid};
      }
      const p0=pts[i], p1=pts[i+1];
      const span=p1.t-p0.t || 1;
      const f=(timeMs-p0.t)/span;
      const temp= (p0.temp!=null && p1.temp!=null) ? lerp(p0.temp,p1.temp,f) : (p0.temp ?? p1.temp);
      const pop = (p0.pop!=null  && p1.pop!=null ) ? lerp(p0.pop,p1.pop,f)   : (p0.pop  ?? p1.pop );
      const wid = f<0.5 ? p0.wid : p1.wid;
      return {temp,pop,wid};
    }

    const start=new Date(now); start.setMinutes(0,0,0); start.setHours(start.getHours()+1);
    const out=[];
    for(let i=0;i<24;i++){
      const t=new Date(start); t.setHours(start.getHours()+i);
      const s=sampleAt(t.getTime());
      out.push({dt:t, temp:s.temp, pop:s.pop, wid:s.wid});
    }
    return out;
  }

  /* ===== render ===== */
  function renderHeader(cityInfo,current){
    document.getElementById("city").textContent=cityInfo.nameTH;
    const temp=Math.round(current?.main?.temp ?? 0);
    document.getElementById("temp").textContent=temp;

    const windMs=current?.wind?.speed ?? 0;
    const windKmh=Math.round(windMs*3.6);
    const wid=current?.weather?.[0]?.id ?? 800;
    const descTH=current?.weather?.[0]?.description || wmoDescTHFromOW(wid);
    document.getElementById("desc").textContent=`${descTH} • ลม ${windKmh} km/h`;
  }

  function renderAlerts(list){
    const daily=groupDailyFromForecast(list).slice(0,7);
    const danger=daily.some(d=>(d.popAvg??0)>=60); // ใช้ค่าเฉลี่ยทั้งวัน
    const alertBox=document.getElementById("alertBox");
    if(danger){ alertBox.style.display="block"; document.getElementById("alertTitle").textContent="คำเตือนเรื่องฝนตกหนัก"; }
    else{ alertBox.style.display="none"; }

    const next=(list||[]).find(it=>((it.pop??0)*100)>=40);
    const hint=document.getElementById("rainHint");
    if(next){ const t=new Date(next.dt*1000); hint.style.display="block"; hint.textContent=`คาดว่ามีฝนตก ประมาณเวลา ${pad2(t.getHours())}:00`; }
    else{ hint.style.display="none"; }
  }

  function addHourCard(parent,label,icon,temp,pop){
    const div=document.createElement("div"); div.className="hcard";
    const tempTxt=(temp==null||Number.isNaN(temp))?"—":Math.round(temp);
    const popTxt =(pop==null ||Number.isNaN(pop)) ?0:Math.round(pop);
    div.innerHTML=`
      <div class="h-time">${label}</div>
      <div class="h-emoji">${icon||"🌡️"}</div>
      <div class="h-temp">${tempTxt}°</div>
      <div class="h-pop">${popTxt}%</div>
    `;
    parent.appendChild(div);
  }

  function renderHourly(current,list){
    const wrap=document.getElementById("hourly"); wrap.innerHTML="";
    const nowPop=Math.round(((list?.[0]?.pop ?? 0)*100));
    const nowIcon=owIdToEmoji(current?.weather?.[0]?.id ?? 800);
    addHourCard(wrap,"ตอนนี้",nowIcon,current?.main?.temp ?? null,nowPop);

    const hourly24=expandToHourly24(current,list||[]);
    hourly24.forEach(h=>{
      addHourCard(wrap, hourLabel(h.dt), owIdToEmoji(h.wid), h.temp, h.pop);
    });
  }

  function buildDailyBars(days){
    const allMin=Math.min(...days.map(d=>d.tmin));
    const allMax=Math.max(...days.map(d=>d.tmax));
    return days.map(d=>{
      const left=((d.tmin-allMin)/(allMax-allMin+0.0001))*100;
      const right=((d.tmax-allMin)/(allMax-allMin+0.0001))*100;
      return {...d,left,width:Math.max(6,right-left)};
    });
  }

  function renderDaily(list){
    const days7=groupDailyFromForecast(list).slice(0,7);
    const bars=buildDailyBars(days7);
    const dWrap=document.getElementById("daily"); dWrap.innerHTML="";
    const today=new Date(); const todayKey=today.toLocaleDateString('th-TH');
    bars.forEach(day=>{
      const isToday=day.key===todayKey;
      const wd=isToday?"วันนี้":day.dateObj.toLocaleDateString("th-TH",{weekday:"short"});
      const emoji = popEmoji(Math.round(day.popAvg??0)); // ใช้ emoji ตาม %ฝนเหมือนเดิม

      const row=document.createElement("div"); row.className="drow";
      row.innerHTML=`
        <div class="d-name">${wd}</div>
        <div class="d-min">${Math.round(day.tmin)}°</div>
        <div class="bar"><div class="bar-fill" style="left:${day.left}%;width:${day.width}%"></div></div>
        <div class="d-max">${Math.round(day.tmax)}°</div>
        <div class="emo">${emoji}</div>
        <div class="pop muted"><span>${Math.round(day.popAvg??0)}%</span></div>
      `;
      dWrap.appendChild(row);
    });
  }

  /* ===== load & init ===== */
  async function loadWeather(){
    try{
      const cityKey=document.getElementById("citySel").value || "bangkok";
      const {cityInfo,current,forecast}=await fetchWeather(cityKey);
      renderHeader(cityInfo,current);
      renderAlerts(forecast.list||[]);
      renderHourly(current,forecast.list||[]);
      renderDaily(forecast.list||[]);
    }catch(err){
      alert(err.message||"โหลดข้อมูลล้มเหลว");
      console.error(err);
    }
  }


  /* ===== ESP32 Sensor Data Integration ===== */
  let sensorChart = null;
  let currentChartHours = 6;

  // API base URL - will work both locally and on Vercel
  const API_BASE = window.location.origin;

  async function fetchSensorData(hours = 24) {
    try {
      const response = await fetch(`${API_BASE}/api/sensors/data?hours=${hours}&limit=1000`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Error fetching sensor data:', error);
      return null;
    }
  }

  async function fetchLatestSensorData() {
    try {
      const response = await fetch(`${API_BASE}/api/sensors/latest`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    } catch (error) {
      console.error('Error fetching latest sensor data:', error);
      return null;
    }
  }

  function formatRelativeTime(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffMs = now - date;
    const diffMinutes = Math.floor(diffMs / (1000 * 60));
    
    if (diffMinutes < 1) return 'เมื่อสักครู่';
    if (diffMinutes < 60) return `${diffMinutes} นาทีก่อน`;
    
    const diffHours = Math.floor(diffMinutes / 60);
    if (diffHours < 24) return `${diffHours} ชั่วโมงก่อน`;
    
    const diffDays = Math.floor(diffHours / 24);
    return `${diffDays} วันก่อน`;
  }

  function updateSensorStatus(isOnline, lastUpdate) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    if (isOnline) {
      statusDot.className = 'online';
      statusText.textContent = 'ออนไลน์';
      statusText.style.color = '#4CAF50';
    } else {
      statusDot.className = 'offline';
      statusText.textContent = lastUpdate ? `ออฟไลน์ • ${formatRelativeTime(lastUpdate)}` : 'ออฟไลน์';
      statusText.style.color = '#f44336';
    }
  }

  function updateSensorDisplay(data) {
    if (!data || data.length === 0) {
      document.getElementById('sensorTemp').textContent = '--°C';
      document.getElementById('sensorHumidity').textContent = '--%';
      document.getElementById('sensorTempTime').textContent = '--';
      document.getElementById('sensorHumidityTime').textContent = '--';
      updateSensorStatus(false);
      return;
    }

    const latest = data[0];
    const temp = latest.sensorData.temperature;
    const humidity = latest.sensorData.humidity;
    const timestamp = latest.sensorData.timestamp;
    
    document.getElementById('sensorTemp').textContent = `${temp.toFixed(1)}°C`;
    document.getElementById('sensorHumidity').textContent = `${humidity.toFixed(0)}%`;
    
    const timeStr = formatRelativeTime(timestamp);
    document.getElementById('sensorTempTime').textContent = timeStr;
    document.getElementById('sensorHumidityTime').textContent = timeStr;
    
    // Consider online if last reading is within 5 minutes
    const isOnline = (new Date() - new Date(timestamp)) < 5 * 60 * 1000;
    updateSensorStatus(isOnline, timestamp);
  }

  function createSensorChart(data) {
    const ctx = document.getElementById('sensorChart');
    if (!ctx) return;

    // Destroy existing chart
    if (sensorChart) {
      sensorChart.destroy();
    }

    if (!data || data.length === 0) {
      ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
      return;
    }

    // Sort data by timestamp
    const sortedData = data.sort((a, b) => new Date(a.sensorData.timestamp) - new Date(b.sensorData.timestamp));
    
    const labels = sortedData.map(item => {
      const date = new Date(item.sensorData.timestamp);
      return date.toLocaleTimeString('th-TH', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
      });
    });

    const tempData = sortedData.map(item => item.sensorData.temperature);
    const humidityData = sortedData.map(item => item.sensorData.humidity);

    sensorChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'อุณหภูมิ (°C)',
            data: tempData,
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.1,
            yAxisID: 'y'
          },
          {
            label: 'ความชื้น (%)',
            data: humidityData,
            borderColor: '#4ecdc4',
            backgroundColor: 'rgba(78, 205, 196, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.1,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: 'var(--text)',
              font: {
                size: 11
              }
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: 'var(--muted)',
              font: {
                size: 10
              },
              maxTicksLimit: 8
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            ticks: {
              color: '#ff6b6b',
              font: {
                size: 10
              }
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            title: {
              display: true,
              text: '°C',
              color: '#ff6b6b'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            ticks: {
              color: '#4ecdc4',
              font: {
                size: 10
              }
            },
            grid: {
              drawOnChartArea: false,
            },
            title: {
              display: true,
              text: '%',
              color: '#4ecdc4'
            }
          }
        },
        elements: {
          point: {
            radius: 1,
            hoverRadius: 4
          }
        }
      }
    });
  }

  async function loadSensorData(hours = currentChartHours) {
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    
    // Show loading state
    statusDot.className = 'loading';
    statusText.textContent = 'กำลังโหลด...';
    statusText.style.color = 'var(--muted)';

    try {
      const [sensorData, latestData] = await Promise.all([
        fetchSensorData(hours),
        fetchLatestSensorData()
      ]);

      if (latestData && latestData.success && latestData.data.length > 0) {
        updateSensorDisplay(latestData.data);
      } else {
        updateSensorDisplay([]);
      }

      if (sensorData && sensorData.success && sensorData.data.length > 0) {
        createSensorChart(sensorData.data);
      } else {
        createSensorChart([]);
      }
    } catch (error) {
      console.error('Error loading sensor data:', error);
      updateSensorDisplay([]);
      createSensorChart([]);
      updateSensorStatus(false);
    }
  }

  // Chart time range buttons
  document.addEventListener('DOMContentLoaded', () => {
    const chartButtons = document.querySelectorAll('.chart-btn');
    chartButtons.forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const hours = parseInt(e.target.dataset.hours);
        currentChartHours = hours;
        
        // Update active button
        chartButtons.forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        
        // Reload chart data
        await loadSensorData(hours);
      });
    });
  });

  // Auto-refresh sensor data every 2 minutes
  setInterval(() => {
    loadSensorData(currentChartHours);
  }, 2 * 60 * 1000);

  document.getElementById("citySel").addEventListener("change",loadWeather);

  (async ()=>{
    await loadCities();
    const themeSel=document.getElementById("themeSel");
    const savedMode=localStorage.getItem("themeMode")||"auto";
    themeSel.value=savedMode;
    themeSel.addEventListener("change",e=>applyThemeMode(e.target.value));
    applyThemeMode(savedMode);
    await loadWeather();
    
    // Load sensor data after page initialization
    await loadSensorData(currentChartHours);
  })();
</script>
</body>
</html>
